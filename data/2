<script setup>
import { ref, watch, computed, nextTick, onMounted } from 'vue'
import { useRouter, useRoute } from 'vue-router'
// Import necessary icons
import {
  VideoPlay,
  CircleCheckFilled,
  ChatDotRound,
  Collection, // ä»å¯ç”¨äºæ˜¾ç¤ºéæœç´¢çš„ä¸‹è½½èµ„æºï¼Œä½†ä¸å†ç”¨äºæœç´¢å›¾æ ‡
  Download,
  Search,
  Picture, // ç”¨äº Slides
  VideoCamera
} from '@element-plus/icons-vue'

// --- 1. åˆå§‹åŒ–æ‰€æœ‰æ•°æ®ä¸º null æˆ–ç©ºæ•°ç»„ ---
const courseData = ref(null);
const isLoading = ref(true);
const error = ref(null);

// --- 2. ä½¿ç”¨è®¡ç®—å±æ€§ä» courseData ä¸­å®‰å…¨åœ°æ´¾ç”Ÿå‡ºå„ä¸ªéƒ¨åˆ†çš„æ•°æ® ---
const courseTitle = computed(() => courseData.value?.title || 'Loading...');
const courseProgress = computed(() => courseData.value?.progress || 0);
const curriculum = computed(() => courseData.value?.curriculum || []);
// resources ä»åŒ…å«æ‰€æœ‰èµ„æºï¼Œä½†æœç´¢ä»…é’ˆå¯¹ slide ç±»å‹
const resources = computed(() => courseData.value?.resources || {});
const completedLessons = computed(() => courseData.value?.completedLessons || []);

// --- 3. é¡µé¢å†…éƒ¨çŠ¶æ€ ---
const currentLessonId = ref(null)
const activeTabName = ref('Transcript') // é»˜è®¤æ˜¾ç¤ºè½¬å½•é¡µ
const videoPlayer = ref(null)
const activeCollapse = ref([])
const justChangedTab = ref('')
const infoTabsRef = ref(null)
const highlightQuery = ref('')


const router = useRouter()
const route = useRoute()

// --- SEARCH LOGIC (å·²é‡æ„) ---
const isSearchDrawerVisible = ref(false)
const quickSearchQuery = ref('')
const quickSearchResults = ref([])
const isSearching = ref(false)
const searchableContent = ref([]);

// è°ƒæ•´å›¾æ ‡ï¼Œåªä¿ç•™ Video å’Œ Resource (ä»£è¡¨å¹»ç¯ç‰‡)
const quickSearchIcons = {
  Video: VideoCamera,
  Resource: Picture // å¹»ç¯ç‰‡/å›¾ç‰‡èµ„æº
};


// =======================================================================
// BUG FIX: æ­¥éª¤ 1 - åˆ›å»ºä¸€ä¸ªç»Ÿä¸€çš„è·¯ç”±å¤„ç†å‡½æ•°
// è¿™ä¸ªå‡½æ•°è´Ÿè´£æ ¹æ®URLçš„ query å’Œ hash æ¥æ›´æ–°ç»„ä»¶çš„çŠ¶æ€
// =======================================================================
function handleRouteChange(query) {
  console.log('âš™ï¸ [HANDLER]: handleRouteChange å‡½æ•°è¢«è°ƒç”¨ï¼Œå‚æ•°ä¸º:', query);
  const { lessonId, targetTab, highlight, timestamp } = query;

  // 1. è®¾ç½®å½“å‰è¯¾æ—¶
  if (lessonId) {
    currentLessonId.value = lessonId;
  }

  // 2. è®¾ç½®é«˜äº®æŸ¥è¯¢è¯
  highlightQuery.value = highlight || '';

  // 3. åˆ‡æ¢åˆ°ç›®æ ‡Tab
  if (targetTab) {
    activeTabName.value = targetTab;
    justChangedTab.value = targetTab;
    setTimeout(() => { justChangedTab.value = ''; }, 1200);
  }

  // 4. å¤„ç†è§†é¢‘æ—¶é—´æˆ³è·³è½¬
  if (timestamp) {
    nextTick(() => {
      if (videoPlayer.value) {
        const timeParts = timestamp.split(':');
        const seconds = parseInt(timeParts[0], 10) * 60 + parseInt(timeParts[1], 10);
        videoPlayer.value.currentTime = seconds;
        videoPlayer.value.play();
        videoPlayer.value.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    });
  }

  // 5. [åŠ å›ºç‰ˆ] å¤„ç†é¡µé¢é”šç‚¹è·³è½¬
  if (route.hash) {
    nextTick(() => {
      // å¢åŠ ä¸€ä¸ªçŸ­æš‚å»¶æ—¶ï¼Œç¡®ä¿tabåˆ‡æ¢åŠ¨ç”»å’ŒDOMæ¸²æŸ“å®Œæˆ
      setTimeout(() => {
        const element = document.querySelector(route.hash);
        if (element) {
          console.log(`âœ… [HANDLER]: æ‰¾åˆ°äº†å…ƒç´  ${route.hash}ï¼Œæ­£åœ¨æ»šåŠ¨...`);
          element.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
          console.error(`âŒ [HANDLER]: æœªèƒ½æ‰¾åˆ°é€‰æ‹©å™¨ä¸º ${route.hash} çš„å…ƒç´ ï¼`);
        }
      }, 150); // 150ms çš„å»¶æ—¶è¶³å¤Ÿåº”å¯¹å¤§å¤šæ•°æƒ…å†µ
    });
  }
}


// =======================================================================
// BUG FIX: æ­¥éª¤ 2 - ä½¿ç”¨ watch ä¾¦å¬è·¯ç”±å˜åŒ–
// è¿™æ˜¯ä¿®å¤ç»„ä»¶å¤ç”¨æ—¶é¡µé¢ä¸æ›´æ–°çš„æ ¸å¿ƒ
// =======================================================================
watch(
  // ä¾¦å¬å®Œæ•´çš„è·¯ç”±è·¯å¾„ (åŒ…æ‹¬ query å’Œ hash)
  () => route.fullPath,
  (newPath, oldPath) => {
    // ç¡®ä¿ç»„ä»¶å·²ç»åŠ è½½å®Œåˆå§‹æ•°æ®åå†æ‰§è¡Œï¼Œé¿å…ä¸å¿…è¦çš„é‡å¤è°ƒç”¨
    // åŒæ—¶ç¡®ä¿è·¯å¾„ç¡®å®å‘ç”Ÿäº†å˜åŒ–
    if (newPath !== oldPath && courseData.value) {
      console.log(`ğŸ”„ [WATCHER]: ä¾¦æµ‹åˆ°è·¯ç”±å˜åŒ–ï¼Œå‡†å¤‡æ›´æ–°ç»„ä»¶...`);

      // route.query æ˜¯å“åº”å¼çš„ï¼Œæ­¤æ—¶å·²ç»æ˜¯æœ€æ–°çš„å€¼
      // è°ƒç”¨ä½ å·²ç»å†™å¥½çš„æ ¸å¿ƒå¤„ç†å‡½æ•°æ¥æ›´æ–°æ‰€æœ‰çŠ¶æ€
      handleRouteChange(route.query);
    }
  }
);

// =======================================================================
// BUG FIX: æ­¥éª¤ 3 - ä¿®æ”¹ onMounted
// onMounted ç°åœ¨åªè´Ÿè´£åˆå§‹æ•°æ®åŠ è½½å’Œé¦–æ¬¡é¡µé¢çŠ¶æ€è®¾ç½®
// =======================================================================
onMounted(async () => {
  const courseId = route.params.id || 1;

  try {
    isLoading.value = true;
    const response = await fetch(`http://localhost:3000/courses/${courseId}`);
    if (!response.ok) {
      throw new Error(`è¯·æ±‚è¯¾ç¨‹æ•°æ®å¤±è´¥ã€‚çŠ¶æ€ç : ${response.status}`);
    }
    const data = await response.json();
    courseData.value = data;
    searchableContent.value = buildSearchIndex(data);

    // å¦‚æœURLæ²¡æœ‰æä¾›lessonIdï¼Œåˆ™è®¾ç½®ä¸€ä¸ªé»˜è®¤å€¼
    if (!route.query.lessonId) {
      if (data.curriculum && data.curriculum.length > 0) {
        const firstSection = data.curriculum[0];
        activeCollapse.value = [firstSection.id];
        if (firstSection.lessons && firstSection.lessons.length > 0) {
          currentLessonId.value = firstSection.lessons[0].id;
        }
      }
    }

    // åœ¨åˆå§‹åŠ è½½æ—¶ï¼Œè°ƒç”¨ä¸€æ¬¡è·¯ç”±å¤„ç†å‡½æ•°æ¥è®¾ç½®é¡µé¢
    handleRouteChange(route.query);

  } catch (e) {
    console.error(e);
    error.value = e.message;
  } finally {
    isLoading.value = false;
  }
});


function highlightText(text, query) {
  if (!query || !text) return text;
  const regex = new RegExp(`(${query})`, 'gi');
  return text.replace(regex, `<span class="highlight">$1</span>`);
}

function buildSearchIndex(data) {
  const index = [];
  if (!data) return [];
  const courseId = data.id;

  const getLessonTitle = (lessonId) => {
    for (const section of data.curriculum || []) {
      const lesson = section.lessons?.find(l => l.id === lessonId);
      if (lesson) return lesson.title;
    }
    return 'Unknown Lesson';
  };

  // 1. ç´¢å¼•è§†é¢‘æ–‡å­—ç¨¿ (Video Transcripts)
  for (const section of data.curriculum || []) {
    for (const lesson of section.lessons || []) {
      if (lesson.transcripts && Array.isArray(lesson.transcripts)) {
        lesson.transcripts.forEach(transcript => {
          index.push({
            type: 'Video', id: `video-${lesson.id}-${transcript.time}`, lessonId: lesson.id, courseId: courseId,
            originalTitle: lesson.title, // å­˜å‚¨åŸå§‹æ ‡é¢˜
            title: lesson.title, // ä»ç„¶ä¿ç•™ title å­—æ®µï¼Œä»¥ä¾¿äº filter å’Œ sort
            snippet: transcript.text,
            source: `Lesson ${lesson.id}`, // æ›´ç®€æ´çš„æ¥æº
            timestamp: transcript.time, lessonNumber: parseInt(lesson.id.split('-')[0], 10),
          });
        });
      }
    }
  }

  // 2. ç´¢å¼•å¹»ç¯ç‰‡ (Slides as Resources)
  // ä»…ç´¢å¼•æ˜ç¡®æ ‡è®°ä¸º 'slide' ç±»å‹ä¸”æœ‰ searchableContent çš„èµ„æº
  for (const lessonId in data.resources || {}) {
    for (const r of data.resources[lessonId] || []) {
      if (r.type === 'slide' && r.searchableContent && Array.isArray(r.searchableContent)) {
        r.searchableContent.forEach(content => {
          index.push({
            type: 'Resource', // ä½¿ç”¨ Resource ç±»å‹ä»£è¡¨å¹»ç¯ç‰‡
            id: `resource-${r.id}-p${content.page || content.text.slice(0, 5)}`, // å¯ä»¥åŒ…å«é¡µé¢ä¿¡æ¯
            lessonId: lessonId, courseId: courseId,
            originalTitle: r.name, // å­˜å‚¨å¹»ç¯ç‰‡åŸå§‹åç§°
            title: `${r.name} (Page ${content.page || 'N/A'})`, // title å­—æ®µåŒ…å«é¡µç ï¼Œç”¨äºé«˜äº®æ˜¾ç¤ºåœ¨å­é¡¹ç‰‡æ®µä¸­
            snippet: content.text,
            source: `Slide ${r.id}`, // æ›´ç®€æ´çš„æ¥æº
            lessonNumber: parseInt(lessonId.split('-')[0], 10), // ä» lessonId è·å–æ•°å­—éƒ¨åˆ†
            page: content.page, // å­˜å‚¨é¡µé¢ä¿¡æ¯ï¼Œæ–¹ä¾¿è·³è½¬
            previewImage: r.previewImage || null // å¹»ç¯ç‰‡é¢„è§ˆå›¾è·¯å¾„
          });
        });
      }
    }
  }

  return index;
}


watch(quickSearchQuery, (newQuery) => {
  if (newQuery.length > 2) {
    isSearching.value = true
    setTimeout(() => {
      const query = newQuery.toLowerCase()
      quickSearchResults.value = searchableContent.value
        .filter(item => item.originalTitle?.toLowerCase().includes(query) || item.snippet.toLowerCase().includes(query))
        .map(item => ({
          ...item,
          // ä¿ç•™åŸå§‹ title å’Œ snippetï¼ŒåŒæ—¶æä¾›é«˜äº®ç‰ˆæœ¬
          highlightedTitle: highlightText(item.originalTitle, newQuery), // å¯¹åŸå§‹æ ‡é¢˜è¿›è¡Œé«˜äº®
          highlightedSnippet: highlightText(item.snippet.replace(/<[^>]*>/g, '').substring(0, 100) + '...', newQuery)
        }))
      isSearching.value = false
    }, 500)
  } else {
    quickSearchResults.value = []
  }
})

// å¿«é€Ÿæœç´¢æŠ½å±‰å†…ï¼šå°†åŒä¸€è§†é¢‘/å¹»ç¯ç‰‡çš„ä¸åŒæ—¶é—´æˆ³/é¡µç æ•´åˆåœ¨ä¸€ä¸ªå¡ç‰‡ç»“æœä¸­
const groupedQuickSearchResults = computed(() => {
  const grouped = new Map();
  quickSearchResults.value.forEach(result => {
    let key;
    let groupTitle;
    let groupSource;
    let commonPreviewImage; // ç”¨äºå¹»ç¯ç‰‡

    if (result.type === 'Video') {
      key = `video-group-${result.lessonId}`;
      groupTitle = result.originalTitle; // ä½¿ç”¨åŸå§‹æ ‡é¢˜ä½œä¸ºç»„æ ‡é¢˜
      groupSource = `Lesson ${result.lessonId}`; // è§†é¢‘çš„æ¥æºæ˜¯è¯¾æ—¶åç§°
    } else if (result.type === 'Resource') { // å¹»ç¯ç‰‡
      key = `resource-group-${result.id.split('-p')[0]}`; // å¹»ç¯ç‰‡æŒ‰å…¶åŸºç¡€IDåˆ†ç»„ (å»æ‰é¡µç )
      groupTitle = result.originalTitle; // ä½¿ç”¨å¹»ç¯ç‰‡åŸå§‹æ ‡é¢˜ä½œä¸ºç»„æ ‡é¢˜ (ä¸å¸¦Page X)
      groupSource = `Slide: ${result.originalTitle}`; // å¹»ç¯ç‰‡æ¥æºå°±æ˜¯å…¶åŸå§‹åç§°
      commonPreviewImage = result.previewImage; // å¹»ç¯ç‰‡çš„é€šç”¨é¢„è§ˆå›¾
    } else {
        return; // ä¸å¤„ç†å…¶ä»–ç±»å‹
    }

    // åªåœ¨ç¬¬ä¸€æ¬¡é‡åˆ°è¯¥ç»„æ—¶åˆ›å»ºï¼Œç¡®ä¿ groupTitle, groupSource ç­‰åªè®¾ç½®ä¸€æ¬¡
    if (!grouped.has(key)) {
        grouped.set(key, {
            isGroup: true, // éƒ½æ˜¯åˆ†ç»„ç»“æœ
            type: result.type,
            icon: quickSearchIcons[result.type],
            source: groupSource, // ä½¿ç”¨å¤„ç†åçš„æ¥æº
            title: groupTitle, // ä½¿ç”¨å¤„ç†åçš„æ ‡é¢˜
            lessonId: result.lessonId,
            courseId: result.courseId,
            previewImage: commonPreviewImage, // å¹»ç¯ç‰‡é¢„è§ˆå›¾
            children: [] // å­˜æ”¾è¯¥è§†é¢‘/å¹»ç¯ç‰‡ä¸‹çš„æ‰€æœ‰åŒ¹é…ç‰‡æ®µ
        });
    }

    const groupItem = grouped.get(key);
    groupItem.children.push({
        id: result.id,
        snippet: result.snippet, // åŸå§‹ snippet
        timestamp: result.timestamp, // è§†é¢‘æ—¶é—´æˆ³
        page: result.page,           // å¹»ç¯ç‰‡é¡µç 
        highlightedSnippet: result.highlightedSnippet, // å­é¡¹é«˜äº®ç‰‡æ®µ
    });
  });
  return Array.from(grouped.values());
});


function goToDeepSearch() {
  if (!quickSearchQuery.value) return;
  const courseId = route.params.id;
  router.push({
    name: 'SearchView',
    query: {
      courseId: courseId,
      q: quickSearchQuery.value
    }
  })
}

// --- COMPUTED PROPERTIES ---
const activeResources = computed(() => resources.value[currentLessonId.value]?.filter(r => r.type === 'slide') || []);
const activeVideo = computed(() => {
  if (!curriculum.value || curriculum.value.length === 0 || !currentLessonId.value) return '';
  const lesson = curriculum.value.flatMap(sec => sec.lessons).find(l => l.id === currentLessonId.value);
  return lesson ? lesson.video : '';
});

// è·å–å½“å‰è¯¾æ—¶çš„æ‰€æœ‰è½¬å½•æ–‡æœ¬
const activeTranscripts = computed(() => {
  if (!curriculum.value || curriculum.value.length === 0 || !currentLessonId.value) return [];
  const lesson = curriculum.value.flatMap(sec => sec.lessons).find(l => l.id === currentLessonId.value);
  if (!lesson || !lesson.transcripts || !Array.isArray(lesson.transcripts)) return [];
  // å¯¹è½¬å½•æ–‡æœ¬è¿›è¡Œé«˜äº®å¤„ç†
  return lesson.transcripts.map(t => ({
    ...t,
    highlightedText: highlightText(t.text, highlightQuery.value)
  }));
});


// --- METHODS ---
function selectLesson(lesson) {
  router.push({
    query: { lessonId: lesson.id }
  });
}

// è§†é¢‘è½¬å½•ç‚¹å‡»äº‹ä»¶ï¼šè·³è½¬è§†é¢‘æ—¶é—´
function jumpToVideoTimestamp(timestamp) {
  if (videoPlayer.value) {
    const timeParts = timestamp.split(':');
    const seconds = parseInt(timeParts[0], 10) * 60 + parseInt(timeParts[1], 10);
    videoPlayer.value.currentTime = seconds;
    videoPlayer.value.play();
    videoPlayer.value.scrollIntoView({ behavior: 'smooth', block: 'center' }); // æ»šåŠ¨åˆ°è§†é¢‘æ’­æ”¾å™¨
  }
}

// å¿«é€Ÿæœç´¢ç»“æœç‚¹å‡»å¤„ç†å‡½æ•°
function handleQuickSearchResultClick(groupItem, childItem) {
  const resultType = groupItem.type;
  const lessonId = groupItem.lessonId;
  const highlightVal = quickSearchQuery.value;

  const queryParams = {
    lessonId: lessonId,
    highlight: highlightVal,
  };
  let hash = '';
  let targetTab = 'Transcript'; // é»˜è®¤è·³è½¬åˆ°è½¬å½•é¡µ

  if (resultType === 'Video') {
    // è§†é¢‘ç‚¹å‡»å…·ä½“çš„æ—¶é—´æˆ³ï¼Œè·³è½¬åˆ°è½¬å½•é¡µå¹¶æ’­æ”¾è§†é¢‘
    queryParams.timestamp = childItem.timestamp;
    hash = '#video-player-container'; // å®šä½åˆ°è§†é¢‘æ’­æ”¾å™¨
    targetTab = 'Transcript'; // æ˜ç¡®è·³è½¬åˆ°Transcriptæ ‡ç­¾é¡µ
  } else if (resultType === 'Resource') { // å¹»ç¯ç‰‡
    // å¹»ç¯ç‰‡ç‚¹å‡»ï¼Œè·³è½¬åˆ° Slides æ ‡ç­¾é¡µï¼Œå¹¶é”šç‚¹åˆ°èµ„æºé¡¹
    targetTab = 'Resources'; // æ˜ç¡®è·³è½¬åˆ°Slidesæ ‡ç­¾é¡µ
    const resourceBaseId = childItem.id.split('-p')[0]; // è·å–å¹»ç¯ç‰‡åŸºç¡€ID
    hash = `#${resourceBaseId}`; // é”šç‚¹åˆ°èµ„æºé¡¹ID
  } else {
    console.warn("Unexpected search result type:", resultType);
    return; // ä¸å¤„ç†æœªçŸ¥ç±»å‹
  }

  queryParams.targetTab = targetTab;

  router.push({
    query: queryParams,
    hash: hash
  });

  isSearchDrawerVisible.value = false; // å…³é—­æŠ½å±‰
}
</script>

<template>
  <div v-if="isLoading" class="loading-state">
    <p>Loading course data...</p>
  </div>
  <div v-else-if="error" class="error-state">
    <p>Error: {{ error }}</p>
    <p>Please make sure your json-server is running and the course ID is correct.</p>
  </div>

  <div v-else class="course-page">
    <div class="top-area">
      <h1 class="course-title">{{ courseTitle }}</h1>
      <div class="top-controls">
        <el-button
          :icon="Search"
          type="primary"
          plain
          @click="isSearchDrawerVisible = true"
        >
          Search
        </el-button>
        <div class="progress-bar-wrapper">
          <el-progress :percentage="courseProgress" />
        </div>
      </div>
    </div>

    <el-row :gutter="30">
      <el-col :span="16">
        <div id="video-player-container" class="video-player-container">
          <video ref="videoPlayer" :key="activeVideo" controls class="video-player">
              <source :src="activeVideo" type="video/mp4">
              Your browser does not support the video tag.
          </video>
        </div>
        <el-tabs v-model="activeTabName" ref="infoTabsRef" type="border-card" class="info-tabs">
          <el-tab-pane label="Transcript" name="Transcript">
            <div class="tab-content transcript-tab" :class="{ 'flash-effect': justChangedTab === 'Transcript' }">
              <h3>Video Transcript for Lesson {{ currentLessonId }}</h3>
              <div v-if="activeTranscripts.length > 0" class="transcript-list">
                <p
                  v-for="(t, index) in activeTranscripts"
                  :key="index"
                  class="transcript-line"
                  @click="jumpToVideoTimestamp(t.time)"
                >
                  <span class="transcript-timestamp">[{{ t.time }}]</span>
                  <span v-html="t.highlightedText"></span>
                </p>
              </div>
              <p v-else>No transcript available for this video.</p>
            </div>
          </el-tab-pane>
          <el-tab-pane label="Slides" name="Resources"> <div class="tab-content resources-tab" :class="{ 'flash-effect': justChangedTab === 'Resources' }">
              <h3>Slides for Lesson {{ currentLessonId }}</h3>
              <ul v-if="activeResources.length > 0" class="resource-list">
                <li v-for="resource in activeResources" :key="resource.id" :id="`resource-${resource.id}`" class="resource-item">
                  <el-icon><Picture /></el-icon> <span class="resource-name">{{ resource.name }}</span>
                  <el-button type="primary" link :icon="Download">Download</el-button>
                </li>
              </ul>
              <p v-else>No slides for this lesson.</p>
            </div>
          </el-tab-pane>
        </el-tabs>
      </el-col>

      <el-col :span="8">
        <div class="sidebar">
          <h3 class="sidebar-title">Course Content</h3>
          <el-collapse class="curriculum-list" v-model="activeCollapse">
            <el-collapse-item
              v-for="section in curriculum"
              :key="section.id"
              :title="section.title"
              :name="section.id"
            >
              <ul>
                <li
                  v-for="lesson in section.lessons"
                  :key="lesson.id"
                  :id="`lesson-item-${lesson.id}`"
                  class="lesson-item"
                  :class="{ 'is-current': lesson.id === currentLessonId }"

                  @click="selectLesson(lesson)"
                >
                  <div class="lesson-status-icon">
                    <el-icon v-if="completedLessons.includes(lesson.id)" color="#67C23A"><CircleCheckFilled /></el-icon>
                    <el-icon v-else><VideoPlay /></el-icon>
                  </div>
                  <div class="lesson-info">
                    <span class="lesson-title">{{ lesson.title }}</span>
                    <span class="lesson-duration">{{ lesson.duration }}</span>
                  </div>
                </li>
              </ul>
            </el-collapse-item>
          </el-collapse>
        </div>
      </el-col>
    </el-row>

    <el-drawer
      v-model="isSearchDrawerVisible"
      title="Search in Course"
      direction="rtl"
      size="40%"
    >
      <div class="search-drawer-content">
        <el-input
          v-model="quickSearchQuery"
          placeholder="Type to search..."
          size="large"
          :prefix-icon="Search"
          clearable
          @keyup.enter="goToDeepSearch"
        />
        <div class="quick-results-area" v-loading="isSearching">
          <div v-if="quickSearchQuery.length > 2 && !isSearching" class="quick-results-summary">
            Found {{ groupedQuickSearchResults.length }} results.
          </div>

          <div v-if="groupedQuickSearchResults.length > 0" class="quick-results-list">
            <div v-for="group in groupedQuickSearchResults" :key="group.type + '-' + group.lessonId + '-' + group.title" class="quick-result-wrapper">
              <div class="quick-result-group-card"> <div class="quick-result-group-header">
                  <div class="quick-result-icon-container">
                    <el-icon class="quick-result-icon"><component :is="group.icon" /></el-icon>
                    <img v-if="group.type === 'Resource' && group.previewImage" :src="group.previewImage" alt="Slide Preview" class="quick-result-slide-preview">
                  </div>
                  <div class="quick-result-details">
                    <p class="quick-result-title">{{ group.title }}</p>
                    <div class="quick-result-meta">
                      <span class="quick-result-source">{{ group.source }}</span>
                    </div>
                  </div>
                </div>
                <div class="quick-result-group-children">
                  <div
                    v-for="child in group.children"
                    :key="child.id"
                    class="quick-result-child-item"
                    @click="handleQuickSearchResultClick(group, child)"
                  >
                    <span v-if="group.type === 'Video'" class="quick-result-context">[ {{ child.timestamp }} ]</span>
                    <span v-else-if="group.type === 'Resource'" class="quick-result-context">[ Page {{ child.page }} ]</span>
                    <p class="quick-result-snippet" v-html="child.highlightedSnippet"></p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <p v-else-if="quickSearchQuery.length > 2 && !isSearching" class="no-quick-results">
            No results found.
          </p>
        </div>
        <el-button
          type="primary"
          link
          class="deep-search-link"
          @click="goToDeepSearch"
        >
          View all results in dedicated page...
        </el-button>
      </div>
    </el-drawer>

  </div>
</template>

<style scoped>
/* --- æµ‹éªŒåé¦ˆçš„æ ·å¼ (å·²åˆ é™¤æˆ–ä¸å†ä½¿ç”¨) --- */
/* --- åŸæœ‰æ ·å¼ --- */
.loading-state, .error-state { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 80vh; font-size: 20px; color: #909399; }
.error-state p:first-child { color: #F56C6C; font-weight: bold; }
.error-state p { margin: 5px 0; }
.course-page { padding: 84px 60px 20px; }
.top-area { margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; }
.course-title { font-size: 28px; font-weight: bold; }
.top-controls { display: flex; align-items: center; gap: 20px; }
.progress-bar-wrapper { width: 200px; }
.video-player-container { width: 100%; aspect-ratio: 16 / 9; background-color: #000; border-radius: 8px; overflow: hidden; }
.video-player { width: 100%; height: 100%; }
.info-tabs { margin-top: 20px; }
.sidebar-title { font-size: 20px; font-weight: bold; margin-bottom: 15px; }
.curriculum-list ul { list-style: none; padding: 0; margin: 0; }
.lesson-item { display: flex; align-items: center; padding: 12px 10px; cursor: pointer; transition: background-color 0.3s; border-bottom: 1px solid #EBEEF5; }
.lesson-item:last-child { border-bottom: none; }
.lesson-item:hover { background-color: #f5f7fa; }
.lesson-item.is-current { background-color: #ecf5ff; font-weight: bold; color: #409EFF; }
.lesson-status-icon { margin-right: 12px; display: flex; align-items: center; }
.lesson-info { flex-grow: 1; display: flex; justify-content: space-between; }
.lesson-title { flex-grow: 1; }
.lesson-duration { font-size: 14px; color: #909399; margin-left: 10px; }
:deep(.el-collapse-item__header) { font-size: 16px; font-weight: 500; }
:deep(.el-collapse-item__content) { padding-bottom: 0; }
.tab-content { padding: 20px; min-height: 250px; }
.tab-content h3 { font-size: 18px; font-weight: bold; margin-top: 0; margin-bottom: 20px; }
.resource-item { display: flex; align-items: center; padding: 10px 5px; border-bottom: 1px solid #EBEEF5; }
.resource-item:last-child { border-bottom: none; }
.resource-item .el-icon { margin-right: 10px; color: #909399; }
.resource-name { flex-grow: 1; color: #606266; }

/* Quick Search Drawer Styles (Updated) */
.search-drawer-content { display: flex; flex-direction: column; height: 100%; }
.quick-results-area { flex-grow: 1; margin-top: 10px; overflow-y: auto; }
.quick-results-summary { font-size: 14px; color: #606266; padding: 0 10px 10px; border-bottom: 1px solid #e4e7ed; }

/* New grouped card for quick search */
.quick-result-group-card {
    border: 1px solid #e4e7ed;
    border-radius: 8px;
    margin-bottom: 15px; /* Space between cards */
    overflow: hidden;
    background-color: #fff;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    transition: box-shadow 0.2s;
}
.quick-result-group-card:hover {
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}

.quick-result-group-header {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    background-color: #f9f9f9;
    border-bottom: 1px solid #e4e7ed;
}

.quick-result-icon-container {
    display: flex;
    align-items: center;
    margin-right: 15px;
    flex-shrink: 0;
}
.quick-result-icon {
    color: #409EFF; /* Blue icon for clarity */
    font-size: 24px;
    margin-right: 5px;
}
.quick-result-slide-preview {
    width: 60px; /* å°é¢„è§ˆå›¾ */
    height: 40px;
    object-fit: cover;
    border-radius: 4px;
    border: 1px solid #ddd;
}


.quick-result-details { flex-grow: 1; overflow: hidden; }
.quick-result-title { font-weight: 600; color: #303133; margin: 0; font-size: 16px; }
.quick-result-meta { font-size: 12px; color: #909399; margin-top: 4px; }


.quick-result-group-children {
    padding: 10px 15px;
    max-height: 200px; /* é™åˆ¶é«˜åº¦å¹¶æ»šåŠ¨ */
    overflow-y: auto;
}
.quick-result-child-item {
    display: flex;
    align-items: flex-start;
    padding: 8px 0;
    cursor: pointer;
    transition: background-color 0.2s;
}
.quick-result-child-item:hover {
    background-color: #f0f2f5;
}

.quick-result-context { font-weight: bold; color: #409EFF; margin-right: 10px; flex-shrink: 0; font-family: monospace;}
.quick-result-snippet { font-size: 14px; color: #606266; line-height: 1.5; flex-grow: 1; overflow: hidden; }

.no-quick-results { color: #909399; text-align: center; padding-top: 40px; }
.deep-search-link { margin-top: auto; }
:deep(.highlight) { background-color: #fdf6ec; color: #e6a23c; font-weight: bold; }
@keyframes flash-background { from { background-color: #fdf6ec; } to { background-color: transparent; } }
.flash-effect { animation: flash-background 1.2s ease-out; }

/* èµ„æºé¡¹å†…éƒ¨çš„é¢„è§ˆå›¾ (è¯¾ç¨‹è¯¦æƒ…é¡µ) - ç¡®ä¿å·²åˆ é™¤ */
.resource-preview-thumbnail {
  display: none; /* å¼ºåˆ¶éšè— */
}


/* æ–°å¢ï¼šè§†é¢‘è½¬å½•æ ·å¼ */
.transcript-tab {
  max-height: 500px; /* é™åˆ¶é«˜åº¦å¹¶æ·»åŠ æ»šåŠ¨æ¡ */
  overflow-y: auto;
}
.transcript-list {
  padding: 10px 0;
}
.transcript-line {
  margin-bottom: 8px;
  line-height: 1.6;
  cursor: pointer;
  padding: 5px;
  border-radius: 4px;
  transition: background-color 0.2s ease;
}
.transcript-line:hover {
  background-color: #f0f2f5;
}
.transcript-timestamp {
  font-weight: bold;
  color: #409EFF;
  margin-right: 10px;
  font-family: monospace;
}

</style>